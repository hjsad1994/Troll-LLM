name: AI Code Review

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request &&
      (
        contains(github.event.comment.body, '@ai-review') ||
        contains(github.event.comment.body, '/review')
      )

    steps:
      - name: Get PR info
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('base_sha', pr.data.base.sha);
            core.setOutput('head_sha', pr.data.head.sha);
            core.setOutput('pr_title', pr.data.title);
            core.setOutput('pr_body', pr.data.body || '');

      - name: Add reaction to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get diff
        run: |
          git fetch origin ${{ steps.pr-info.outputs.base_sha }}
          git fetch origin ${{ steps.pr-info.outputs.head_sha }}
          git diff ${{ steps.pr-info.outputs.base_sha }} ${{ steps.pr-info.outputs.head_sha }} > diff.txt
          echo "=== Diff Size ==="
          wc -l diff.txt

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Run AI Code Review
        id: ai-review
        env:
          API_KEY: ${{ secrets.TROLLLLM_API_KEY }}
          API_ENDPOINT: ${{ secrets.TROLLLLM_ENDPOINT }}
          MODEL_NAME: ${{ secrets.MODEL_NAME }}
          PR_TITLE: ${{ steps.pr-info.outputs.pr_title }}
          PR_BODY: ${{ steps.pr-info.outputs.pr_body }}
        run: python .github/scripts/review.py

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review_result.md', 'utf8');
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('<!-- AI-CODE-REVIEW -->')
            );
            const prNumber = context.issue.number;
            const timestamp = new Date().toISOString();
            const requestedBy = context.payload.comment.user.login;
            const header = '<!-- AI-CODE-REVIEW -->\n## AI Code Review\n\n';
            const meta = '> **PR #' + prNumber + '** | Reviewed at: ' + timestamp + '\n';
            const reqBy = '> Requested by: @' + requestedBy + '\n\n';
            const footer = '\n\n---\n*Comment `@ai-review` or `/review` to request a new review.*';
            const commentBody = header + meta + reqBy + review + footer;
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: Add completion reaction
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });
