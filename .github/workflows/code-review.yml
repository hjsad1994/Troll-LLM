name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    # Skip review for draft PRs and dependabot
    if: |
      github.event.pull_request.draft == false &&
      github.actor != 'dependabot[bot]'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files and diff
        id: changed-files
        run: |
          # Get the diff between base and head
          git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > diff.txt

          # Get list of changed files
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > changed_files.txt

          # Show summary
          echo "=== Changed Files ==="
          cat changed_files.txt
          echo ""
          echo "=== Diff Size ==="
          wc -l diff.txt

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Run AI Code Review
        id: ai-review
        env:
          API_KEY: ${{ secrets.TROLLLLM_API_KEY }}
          API_ENDPOINT: ${{ secrets.TROLLLLM_ENDPOINT }}
          MODEL_NAME: ${{ secrets.MODEL_NAME || 'gpt-4o-mini' }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: python .github/scripts/review.py

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review_result.md', 'utf8');

            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('<!-- AI-CODE-REVIEW -->')
            );

            const prUrl = context.payload.pull_request.html_url;
            const prNumber = context.payload.pull_request.number;
            const timestamp = new Date().toISOString();

            const commentBody = `<!-- AI-CODE-REVIEW -->
## ü§ñ AI Code Review

> **PR #${prNumber}** | Reviewed at: ${timestamp}

${review}

---
<details>
<summary>‚ÑπÔ∏è About this review</summary>

This review was automatically generated by AI Code Reviewer.
- Model: \`${{ secrets.MODEL_NAME || 'gpt-4o-mini' }}\`
- Trigger: Pull Request ${context.payload.action}

**Note:** AI reviews are meant to assist, not replace human reviewers. Always use your judgment.

</details>`;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
              console.log('Updated existing review comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
              console.log('Created new review comment');
            }
