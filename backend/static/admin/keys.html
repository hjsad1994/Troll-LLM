<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Keys - F-Proxy Admin</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app">
        <nav class="sidebar">
            <div class="logo">üîß F-Proxy Admin</div>
            <ul class="nav-links">
                <li><a href="/admin/">üìä Dashboard</a></li>
                <li><a href="/admin/keys.html" class="active">üîë User Keys</a></li>
                <li><a href="/admin/factory-keys.html">üè≠ Factory Keys</a></li>
                <li><a href="/admin/proxies.html">üåê Proxies</a></li>
                <li><a href="/status" target="_blank">üì° Status Page</a></li>
            </ul>
            <div class="user-info">
                <span id="username">admin</span>
                <button onclick="logout()" class="btn-logout">Logout</button>
            </div>
        </nav>
        
        <main class="content">
            <header>
                <h1>üîë User Keys</h1>
            </header>
            
            <div class="toolbar">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search keys..." onkeyup="filterKeys()">
                </div>
                <button class="btn btn-primary" onclick="showModal('createModal')">+ New Key</button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Key ID</th>
                            <th>Name</th>
                            <th>Tier</th>
                            <th>Usage</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="keysTable">
                        <tr><td colspan="6" class="empty-state">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>
    
    <!-- Create Modal -->
    <div class="modal" id="createModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Key</h2>
                <button class="modal-close" onclick="hideModal('createModal')">&times;</button>
            </div>
            <form onsubmit="createKey(event)">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="createName" required placeholder="e.g., John's API Key">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tier</label>
                        <select id="createTier">
                            <option value="dev">Dev (150 RPM)</option>
                            <option value="pro">Pro (300 RPM)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Token Limit</label>
                        <select id="createTokens">
                            <option value="10000000">10M tokens</option>
                            <option value="20000000">20M tokens</option>
                            <option value="30000000" selected>30M tokens</option>
                            <option value="50000000">50M tokens</option>
                            <option value="100000000">100M tokens</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes (optional)</label>
                    <textarea id="createNotes" rows="2" placeholder="Internal notes..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%">Create Key</button>
            </form>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Key</h2>
                <button class="modal-close" onclick="hideModal('editModal')">&times;</button>
            </div>
            <form onsubmit="updateKey(event)">
                <input type="hidden" id="editKeyId">
                <div class="form-group">
                    <label>Key ID</label>
                    <input type="text" id="editKeyDisplay" disabled>
                </div>
                <div class="form-group">
                    <label>Token Limit</label>
                    <select id="editTokens">
                        <option value="10000000">10M tokens</option>
                        <option value="20000000">20M tokens</option>
                        <option value="30000000">30M tokens</option>
                        <option value="50000000">50M tokens</option>
                        <option value="100000000">100M tokens</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="editNotes" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%">Save Changes</button>
            </form>
        </div>
    </div>
    
    <!-- Key Created Modal -->
    <div class="modal" id="keyCreatedModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úÖ Key Created</h2>
                <button class="modal-close" onclick="hideModal('keyCreatedModal')">&times;</button>
            </div>
            <p style="color: #94a3b8; margin-bottom: 16px;">Save this key now. You won't be able to see it again!</p>
            <div class="key-display" id="newKeyDisplay"></div>
            <button class="btn btn-secondary copy-btn" onclick="copyToClipboard(document.getElementById('newKeyDisplay').textContent)">üìã Copy Key</button>
        </div>
    </div>
    
    <script src="admin.js"></script>
    <script>
        let allKeys = [];
        
        checkAuth();
        loadKeys();
        
        async function loadKeys() {
            try {
                const resp = await fetchWithAuth('/admin/keys');
                if (!resp.ok) throw new Error('Failed to load');
                
                const data = await resp.json();
                allKeys = data.keys || [];
                renderKeys(allKeys);
            } catch (err) {
                document.getElementById('keysTable').innerHTML = 
                    '<tr><td colspan="6" class="empty-state"><div class="icon">‚ùå</div>Failed to load keys</td></tr>';
            }
        }
        
        function renderKeys(keys) {
            if (keys.length === 0) {
                document.getElementById('keysTable').innerHTML = 
                    '<tr><td colspan="6" class="empty-state"><div class="icon">üîë</div>No keys yet. Create your first key!</td></tr>';
                return;
            }
            
            document.getElementById('keysTable').innerHTML = keys.map(key => {
                const usage = key.usage_percent || 0;
                const progressClass = usage > 90 ? 'danger' : usage > 70 ? 'warning' : '';
                return `
                <tr>
                    <td><code>${key._id || key.id}</code></td>
                    <td>${key.name}</td>
                    <td><span class="badge badge-${key.tier}">${key.tier.toUpperCase()}</span></td>
                    <td>
                        <div style="width: 120px">
                            <div class="progress-bar">
                                <div class="progress-fill ${progressClass}" style="width: ${Math.min(usage, 100)}%"></div>
                            </div>
                            <small style="color: #64748b">${formatNumber(key.tokensUsed || 0)} / ${formatNumber(key.totalTokens)}</small>
                        </div>
                    </td>
                    <td><span class="badge badge-${key.isActive ? 'active' : 'revoked'}">${key.isActive ? 'Active' : 'Revoked'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editKey('${key._id || key.id}')">Edit</button>
                        <button class="btn btn-sm btn-secondary" onclick="resetKey('${key._id || key.id}')">Reset</button>
                        ${key.isActive 
                            ? `<button class="btn btn-sm btn-danger" onclick="revokeKey('${key._id || key.id}')">Revoke</button>` 
                            : `<button class="btn btn-sm btn-danger" onclick="deleteKey('${key._id || key.id}')">Delete</button>`}
                    </td>
                </tr>
            `}).join('');
        }
        
        function filterKeys() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allKeys.filter(k => 
                k.name.toLowerCase().includes(search) || 
                (k._id || k.id).toLowerCase().includes(search)
            );
            renderKeys(filtered);
        }
        
        async function createKey(e) {
            e.preventDefault();
            try {
                const resp = await fetchWithAuth('/admin/keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('createName').value,
                        tier: document.getElementById('createTier').value,
                        totalTokens: parseInt(document.getElementById('createTokens').value),
                        notes: document.getElementById('createNotes').value
                    })
                });
                
                if (!resp.ok) throw new Error('Failed to create');
                
                const data = await resp.json();
                hideModal('createModal');
                document.getElementById('newKeyDisplay').textContent = data.id;
                showModal('keyCreatedModal');
                loadKeys();
                
                // Reset form
                document.getElementById('createName').value = '';
                document.getElementById('createNotes').value = '';
            } catch (err) {
                showToast('Failed to create key', 'error');
            }
        }
        
        function editKey(keyId) {
            const key = allKeys.find(k => (k._id || k.id) === keyId);
            if (!key) return;
            
            document.getElementById('editKeyId').value = keyId;
            document.getElementById('editKeyDisplay').value = maskKey(keyId);
            document.getElementById('editTokens').value = key.totalTokens;
            document.getElementById('editNotes').value = key.notes || '';
            showModal('editModal');
        }
        
        async function updateKey(e) {
            e.preventDefault();
            const keyId = document.getElementById('editKeyId').value;
            
            try {
                const resp = await fetchWithAuth(`/admin/keys/${keyId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        totalTokens: parseInt(document.getElementById('editTokens').value),
                        notes: document.getElementById('editNotes').value
                    })
                });
                
                if (!resp.ok) throw new Error('Failed to update');
                
                hideModal('editModal');
                showToast('Key updated successfully');
                loadKeys();
            } catch (err) {
                showToast('Failed to update key', 'error');
            }
        }
        
        async function resetKey(keyId) {
            if (!await confirmAction('Reset usage for this key? This will set tokens used to 0.')) return;
            
            try {
                const resp = await fetchWithAuth(`/admin/keys/${keyId}/reset`, { method: 'POST' });
                if (!resp.ok) throw new Error('Failed to reset');
                
                showToast('Usage reset successfully');
                loadKeys();
            } catch (err) {
                showToast('Failed to reset usage', 'error');
            }
        }
        
        async function revokeKey(keyId) {
            if (!await confirmAction('Revoke this key? Users will no longer be able to use it.')) return;
            
            try {
                const resp = await fetchWithAuth(`/admin/keys/${keyId}`, { method: 'DELETE' });
                if (!resp.ok) throw new Error('Failed to revoke');
                
                showToast('Key revoked successfully');
                loadKeys();
            } catch (err) {
                showToast('Failed to revoke key', 'error');
            }
        }
        
        async function deleteKey(keyId) {
            if (!await confirmAction('Permanently delete this key? This cannot be undone!')) return;
            
            try {
                const resp = await fetchWithAuth(`/admin/keys/${keyId}?permanent=true`, { method: 'DELETE' });
                if (!resp.ok) throw new Error('Failed to delete');
                
                showToast('Key deleted permanently');
                loadKeys();
            } catch (err) {
                showToast('Failed to delete key', 'error');
            }
        }
    </script>
</body>
</html>
